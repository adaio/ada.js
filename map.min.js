var map=function(undef,undefined){function map(){var args=Array.prototype.slice.call(arguments),fn;return args.length!=1&&!Array.isArray(args[1])||typeof args[0]!="object"||args[0].constructor!=Object?args.length>1&&args.slice(0,args.length-2).every(isObservable)&&typeof args[args.length-2]=="function"&&typeof args[args.length-1]=="function"?fn=subscribeTo:args.length==1&&Array.isArray(args[0])?fn=pubsub:args.length?(fn=property,args=args.slice(0,1)):fn=pubsub:fn=newObject,fn.apply(undef,args)}function isObservable(el){return el&&el.extendsMapPubsub}function newObject(raw,exceptions){var obj={},key,val;for(key in raw)val=raw[key],obj[key]=!!Array.isArray(exceptions)&&exceptions.indexOf(key)!=-1||typeof val=="object"&&val.constructor==Object||typeof val=="function"?val:(Array.isArray(val)&&pubsub||property)(val);return obj}function publish(from){if(from&&from.subscribers&&from.subscribers.length==0)return;var args=Array.prototype.slice.call(arguments,1),newValue,oldValue;from.subscribers.forEach(function(cb,i){if(!cb||typeof cb.callback!="function")return;if(!cb.isMapSubscriber){try{cb.callback.apply(undef,args)}catch(exc){setTimeout(function(){throw exc},0)}return}from.extendsMapPubsub&&!from.hasCustomProxy&&args.length>1?Array.prototype.splice.apply(cb.harvest,[cb.column,args.length].concat(args)):cb.harvest[cb.column]=args[0],oldValue=cb.harvest.value;if(!cb.batch()){cb.harvest.sync(),cb.getter?(newValue=cb.harvest.value=cb.getter.apply(undef,cb.harvest),cb.pubsub.publish(newValue,oldValue)):cb.pubsub.publish.apply(undef,cb.harvest);return}cb.harvest.call!=undef&&(clearTimeout(cb.harvest.call),cb.call=undef),cb.harvest.call=setTimeout(function(){cb.harvest.sync(),cb.getter?(newValue=cb.harvest.value=cb.getter.apply(undef,cb.harvest),cb.harvest.call=undef,cb.pubsub.publish(newValue,oldValue)):cb.pubsub.publish.apply(undef,cb.harvest)},0)})}function pubsub(customProxy){function sub(callback){subscribe(proxy,callback)}function unsub(callback){unsubscribe(proxy,callback)}function pub(){var args=[proxy];Array.prototype.push.apply(args,arguments),publish.apply(undef,args)}var proxy=customProxy||function pubsubProxy(){arguments.length&&sub.apply(undef,arguments)};return proxy.subscribers=[],proxy.subscribe=sub,proxy.unsubscribe=unsub,proxy.publish=pub,proxy.extendsMapPubsub=!0,proxy.hasCustomProxy=!!customProxy,proxy}function property(rawValue,getter,setter){function get(){return getter?getter(value):value}function propertyProxy(update){return arguments.length>0&&set(update),get()}function raw(update){return arguments.length&&(value=update),value}function set(update,options){var old=!options||!options.skipPublishing?get():undef;return value=setter?setter(update,value):update,(!options||!options.skipPublishing)&&publish(proxy,get(),old),value}var value=undef,proxy=propertyProxy;return pubsub(proxy),proxy.isMapProperty=!0,proxy.raw=raw,proxy.publish=function publishProperty(){var args=[proxy,get()].concat(Array.prototype.slice.call(arguments));return publish.apply(undef,args)},rawValue!==value&&set(rawValue,{skipPublishing:!0}),proxy}function subscribe(to,callback){if(!callback)throw new Error("Invalid callback: "+callback);to.subscribers.push(typeof callback=="function"?{callback:callback}:callback)}function subscribeTo(){function accessor(){return arguments.length?setter.apply(undef,arguments):(harvest.sync(),getter.apply(undef,harvest))}function loop(){var i=-1,col=harvest.length,to=arguments,len=to.length,prop;while(++i<len)prop=to[i],harvest[col+i]=undef,subscriptions[col+i]=prop.isMapProperty?prop:undef,prop.subscribe({isMapSubscriber:!0,callback:callback,getter:getter,setter:setter,pubsub:proxy,harvest:harvest,column:col+i,batch:toBatch})}function toBatch(){return batch}var args=arguments,harvest=[],subscriptions=[],setter=args.length<3||isObservable(args[args.length-2])?undef:args[args.length-1],subscriber=args[args.length-(setter?2:args[args.length-1].extendsMapPubsub?0:1)],batch=!0,proxy,callback,getter;return subscriber?(proxy=pubsub(accessor),getter=subscriber,callback=subscriber):(proxy=pubsub(),getter=undef,callback=proxy.publish),proxy.harvest=harvest,proxy.isMapProperty=!0,proxy.isMapCallback=!0,proxy.subscribeTo=loop,proxy.subscriptions=subscriptions,proxy.setter=function(){return setter=arguments[0],proxy},proxy.sync=function sync(){return batch=!1,proxy},harvest.sync=function(){var i=-1,len=subscriptions.length;while(++i<len){if(harvest[i]!=undef||!subscriptions[i])continue;harvest[i]=subscriptions[i]()}},loop.apply(null,Array.prototype.slice.call(arguments,0,arguments.length-(setter?2:subscriber?1:0))),proxy}function unsubscribe(to,callback){var i=to.subscribers.length;while(i--)if(to.subscribers[i]&&to.subscribers[i].callback==callback)return to.subscribers[i]=undef,i;return!1}return map.pubsub=pubsub,map.property=property,map.subscribeTo=subscribeTo,map}();typeof module!="undefined"&&module.exports&&(module.exports=map);